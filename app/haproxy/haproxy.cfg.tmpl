global
    log stdout format raw local0
    maxconn 4096

defaults
    log global
    mode http
    option httplog
    option log-health-checks
    option logasap
    option dontlognull
    timeout connect 5s
    timeout client 50s
    timeout server 50s
    # WebSocket connections need longer timeouts
    timeout tunnel 1h
    option http-keep-alive
    option http-server-close

frontend http_front
    bind *:5432
    
    # Log all incoming requests - capture headers in frontend only
    capture request header Host len 64
    capture request header User-Agent len 128
    capture request header Neon-Connection-String len 256
    capture request header Authorization len 128
    
    # Backend selection rules will be added here

backend http_backend
    # WebSocket upgrade detection (must be in backend section)
    acl is_websocket hdr(Connection) -i upgrade
    acl is_websocket_upgrade hdr(Upgrade) -i websocket
    acl is_sql_request path_beg /sql
    acl uses_default_creds hdr(Neon-Connection-String) -m reg "postgresql://neon:npg@"
    
    # Default HTTP backend configuration
    server ws_server1 {host}:443 ssl verify none sni str({host}) check
    
    # Debug headers (valid in backend)
    http-request add-header X-Debug-Original-Conn-String "%[req.hdr(Neon-Connection-String)]" if is_sql_request uses_default_creds
    http-request add-header X-Debug-Is-SQL-Request "YES" if is_sql_request
    http-request add-header X-Debug-Uses-Default-Creds "YES" if uses_default_creds
    
    # For regular HTTP requests, set the Neon-Connection-String header
    http-request set-header Neon-Connection-String "postgresql://{role}:{password}@{host}/{database}?sslmode=require" unless is_websocket is_websocket_upgrade
    
    # For SQL requests with default credentials, override with real credentials
    http-request set-header Neon-Connection-String "postgresql://{role}:{password}@{host}/{database}?sslmode=require" if is_sql_request uses_default_creds
    http-request add-header X-Debug-New-Conn-String "%[req.hdr(Neon-Connection-String)]" if is_sql_request uses_default_creds
    
    http-request set-header Host {host}
    
    # For WebSocket connections, set proper Basic Authentication
    http-request add-header X-Debug-WebSocket-Auth "Setting auth for WebSocket" if is_websocket is_websocket_upgrade
    http-request set-header Authorization "Basic {auth_header}" if is_websocket is_websocket_upgrade
    
    # WebSocket support - preserve upgrade headers
    http-request set-header Connection "upgrade" if is_websocket is_websocket_upgrade
    http-request set-header Upgrade "websocket" if is_websocket is_websocket_upgrade
